<% if (theme.site_footer) { %>
  <% 
    var layout = theme.site_footer.layout;
    if (config.theme_config && config.theme_config.footer && config.theme_config.footer.layout) {
      layout = config.theme_config.footer.layout;
    }
    let theme_version = theme.info.theme_version;
  %>

  <footer class="footer clearfix" itemscope itemtype="http://schema.org/WPFooter">
    <br><br>

    <% layout.forEach(function(item){ %>

      <% if (item == 'social') { %>
        <br>
        <div class="social-wrapper" itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <% getList(theme.site_footer.social).forEach(function(value){ %>
            <% if (value.url && (value.icon || value.img || value.avatar)) { %>
              <a href="<%= url_for(value.url) %>" 
                 class="social <%- value.icon %> flat-btn" 
                 target="_blank"
                 rel="external nofollow noopener noreferrer" 
                 itemprop="url">
                <% if (value.img) { %>
                  <img src="<%- value.img %>" />
                <% } else if (value.avatar) { %>
                  <img src="<%- value.avatar %>" style="border-radius:120px" />
                <% } %>
              </a>
            <% } %>
          <% }) %>
        </div>

      <% } else if (item == 'aplayer') { %>
        <div class="aplayer-container">
          <%- partial('../_plugins/aplayer/layout', {post: null, where: 'footer'}) %>
        </div>

      <% } else if (item == 'license') { %>
        <!-- <div><%- markdown(__('footer.license')) %></div> -->

      <% } else if (item == 'info') { %>
        <div class="footer-info">
          Theme <a href="#" target="_blank">Volantis</a> | 
          Modified by <a href="https://www.shika-mori.top" target="_blank">尘尘</a>
          <br />Powered by 
          <div class="footer-images"
               style="display:flex; justify-content:center; align-items:center; gap:10px; margin-top:8px;">
            <img src="https://pic.shika-mori.top/picGO/社团logo.png"
                 data-light="https://pic.shika-mori.top/picGO/社团logo.png"
                 data-dark="https://pic.shika-mori.top/picGO/社团logo-dark.png"
                 alt="Logo 1" class="footer-logo"
                 style="width:120px; height:auto; border-radius:6px;">
            <img src="https://pic.shika-mori.top/picGO/东方行状录标题带英文.png"
                 data-light="https://pic.shika-mori.top/picGO/东方行状录标题带英文.png"
                 data-dark="https://pic.shika-mori.top/picGO/东方行状录标题带英文-dark.png"
                 alt="Logo 2" class="footer-logo"
                 style="width:350px; height:auto; border-radius:6px;">
          </div>
        </div>

        <style>
          .footer-logo {
            transition: opacity 0.18s ease;
            -webkit-user-drag: none;
            user-select: none;
            display: inline-block;
          }
        </style>

        <script>
          (function () {
            const imgsSelector = '.footer-images .footer-logo';
            function isLightMode() {
              const html = document.documentElement;
              if (html.hasAttribute('color-scheme')) {
                return html.getAttribute('color-scheme') === 'light';
              }
              return window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches;
            }
            function updateLogos() {
              const light = isLightMode();
              document.querySelectorAll(imgsSelector).forEach(img => {
                const dataLight = img.getAttribute('data-light');
                const dataDark = img.getAttribute('data-dark');
                const targetSrc = light ? (dataLight || img.src) : (dataDark || img.src);
                if (!targetSrc || img.dataset.currentSrc === targetSrc) return;
                img.style.opacity = '0.4';
                const pre = new Image();
                pre.onload = () => {
                  img.src = targetSrc;
                  img.dataset.currentSrc = targetSrc;
                  img.style.opacity = '1';
                };
                pre.onerror = () => img.style.opacity = '1';
                pre.src = targetSrc;
              });
            }
            document.querySelectorAll(imgsSelector).forEach(img => {
              if (!img.getAttribute('data-light')) {
                img.setAttribute('data-light', img.src || '');
              }
            });
            updateLogos();
            if (window.matchMedia) {
              const handler = () => updateLogos();
              const mqDark = window.matchMedia('(prefers-color-scheme: dark)');
              const mqLight = window.matchMedia('(prefers-color-scheme: light)');
              if (mqDark.addEventListener) {
                mqDark.addEventListener('change', handler);
                mqLight.addEventListener('change', handler);
              } else {
                mqDark.addListener(handler);
                mqLight.addListener(handler);
              }
            }
            const observer = new MutationObserver(muts => {
              for (const m of muts) {
                if (m.type === 'attributes' && m.attributeName === 'color-scheme') {
                  updateLogos();
                  break;
                }
              }
            });
            observer.observe(document.documentElement, { attributes: true });
            window.triggerFooterLogoUpdate = updateLogos;
          })();
        </script>

      <% } else if (item == 'source') { %>
        <%- markdown(__('footer.site_source',
          '[Volantis](https://github.com/volantis-x/hexo-theme-volantis/#' + theme_version + ')',
          'GitHub', 
          'https://github.com/volantis-x/volantis-docs')) %>

      <% } else if (item == 'copyright') { %>
        <div class="copyright">
          <%- markdown(theme.site_footer.copyright) %>
        </div>

      <% } else { %>
        <% if (item in theme.site_footer) { %>
          <div><%- markdown(theme.site_footer[item]) %></div>
        <% } %>
      <% } %>

    <% }) %>

    <!-- Custom Files footer begin -->
    <%- volantis_inject('footer') %>
    <!-- Custom Files footer end -->
  </footer>
<% } %>
