<% if (site.posts && site.posts.length > 0) { %>
  <section class="post-list">
    <% if (!page.prev) { %>
      <% if (is_home()) { %>
        <%
          // 用于去重：记录已渲染的往期一览页面 path
          var renderedMagazinePath = null;
        %>
      <!-- 🌟 最高优先级：往期一览入口（和首页文章样式保持一致） -->
      <% site.pages.each(function(page) { %>
        <% if (page.group === 'magazine' && page.show_on_home) { %>
          <% var postData = {
            post: page,
            is_index: true,
            index_cover: page.headimg,
            index_title: page.title,
            index_excerpt: page.description || '点击查看所有往期内容'
          }; %>

          <div class="post-wrapper magazine-entry">
            <%- partial('_partial/post', postData) %>
          </div>

        <% } %>
      <% }) %>


        <!-- 首页：置顶的 pages（排除 magazine + 已渲染项） -->
        <% site.pages.each(function(post) { %>
          <% if (post.pin && post.path !== renderedMagazinePath) { %>
            <% if ((typeof post.group === 'undefined' || post.group !== 'magazine') && (page.group == undefined || post.group == page.group)) { %>
              <div class='post-wrapper'>
                <%- partial('post', { post: post }) %>
              </div>
            <% } %>
          <% } %>
        <% }) %>

        <!-- 首页：置顶的 posts（排除 magazine + 已渲染项） -->
        <% site.posts.sort('date', -1).each(function(post) { %>
          <% if (post.pin && post.path !== renderedMagazinePath) { %>
            <% if ((typeof post.group === 'undefined' || post.group !== 'magazine') && (page.group == undefined || post.group == page.group)) { %>
              <div class='post-wrapper'>
                <%- partial('post', { post: post }) %>
              </div>
            <% } %>
          <% } %>
        <% }) %>

        <!-- 首页：普通文章（非置顶，排除 magazine + 已渲染项） -->
        <% if (page.posts && page.posts.length > 0) { %>
          <% page.posts.each(function(post) { %>
            <% if (!post.pin && post.path !== renderedMagazinePath) { %>
              <% if (typeof post.group === 'undefined' || post.group !== 'magazine') { %>
                <div class='post-wrapper'>
                  <%- partial('post', { post: post }) %>
                </div>
              <% } %>
            <% } %>
          <% }) %>
        <% } %>

      <% } else if (page.posts && page.posts.length > 0) { %>
        <!-- 非首页：置顶 posts（不过滤 group） -->
        <% page.posts.each(function(post) { %>
          <% if (post.pin) { %>
            <div class='post-wrapper'>
              <%- partial('post', { post: post }) %>
            </div>
          <% } %>
        <% }) %>
      <% } %>
    <% } %>

    <!-- 非首页 or 首页剩余内容：普通文章 -->
    <% if (page.posts && page.posts.length > 0) { %>
      <% page.posts.each(function(post) { %>
        <% if (!post.pin) { %>
          <% if (!is_home() || (typeof post.group === 'undefined' || post.group !== 'magazine')) { %>
            <div class='post-wrapper'>
              <%- partial('post', { post: post }) %>
            </div>
          <% } %>
        <% } %>
      <% }) %>
    <% } %>
  </section>

  <!-- 分页 -->
  <% if (page && page.posts) { %>
    <% if (page.total > 1) { %>
      <br>
      <div class="prev-next">
        <% if (page.prev != 0) { %>
          <a class="prev" rel="prev" href="<%= url_for(page.prev_link) %>">
            <section class="post prev white-box <%- theme.custom_css.body.effect.join(' ') %>" >
              <i class="fa-solid fa-chevron-left" aria-hidden="true"></i>&nbsp;<%- __('post.prev_page') %>&nbsp;
            </section>
          </a>
        <% } %>
        <p class="current">
          <%= page.current%> / <%= page.total%>
        </p>
        <% if (page.next != 0) { %>
          <a class="next" rel="next" href="<%= url_for(page.next_link) %>">
            <section class="post next white-box <%- theme.custom_css.body.effect.join(' ') %>">
              &nbsp;<%- __('post.next_page') %>&nbsp;<i class="fa-solid fa-chevron-right" aria-hidden="true"></i>
            </section>
          </a>
        <% } %>
      </div>
    <% } %>
  <% } %>
<% } %>